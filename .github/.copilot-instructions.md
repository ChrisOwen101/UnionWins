# What Have Unions Done For Us - AI Agent Instructions

## Implementation Steps

1. Make your change to the code
2. Ensure the code builds, fix if it doesn't
3. Ensure lint passes, fix if it doesn't

## Architecture Overview

This is a monorepo containing a **React + TypeScript frontend** (Vite) and a **Python FastAPI backend**. The application tracks trade union victories and uses OpenAI's Deep Research API to automatically discover new What Have Unions Done For Us.

### Key Components

- **Frontend** (`frontend/`): React 18 + TypeScript 5, Vite dev server, Tailwind CSS 4, React Router for `/` (Home) and `/admin` pages
- **Backend** (`backend/src/`): FastAPI with SQLAlchemy ORM, PostgreSQL database, OpenAI integration for automated research
- **Database**: PostgreSQL with two tables: `union_wins` (victories) and `search_requests` (background research tasks)

## Critical Workflows

### Development Setup & Running

**Single command to run everything:**

```bash
./dev.sh
```

This script handles: PostgreSQL startup check, port cleanup (3000, 3001), concurrent frontend + backend startup, and graceful shutdown.

**Individual services:**

- Frontend: `npm run frontend` → http://localhost:3000
- Backend: `npm run backend` → http://localhost:3001 (uses uvicorn with auto-reload)
- Install all: `npm run install:all` (root + frontend npm, backend uses `uv sync`)

### Database Management

- **Connection**: PostgreSQL at `localhost:5432/unionwins` (env var: `DATABASE_URL`)
- **Initialization**: `init_db()` auto-creates tables and seeds sample data if empty
- **Schema evolution**: See [database.py](../backend/src/database.py) for migration pattern (inspect columns, alter table if needed)
- **Manual setup**: Follow [DATABASE_SETUP.md](../backend/DATABASE_SETUP.md)

## Project-Specific Patterns

### Backend Architecture

**Background Research System** ([main.py](../backend/src/main.py)):

- Dedicated daemon thread (`process_pending_requests`) polls `search_requests` table continuously
- Flow: `pending` → create OpenAI background task → `processing` → poll status → `completed`/`failed`
- Research uses `gpt-5-mini` model with `background=True` and `web_search_preview` tool
- Response parsing: Extracts JSON from markdown code blocks, validates schema, deduplicates by URL

**API Endpoints:**

- `GET /api/wins`: Returns all wins sorted by date (newest first)
- `POST /api/wins/search`: Queues background research for last 7 days of UK union victories

**Database Models** ([database.py](../backend/src/database.py)):

- `UnionWinDB`: Stores victories with `union_name`, `title`, `date`, `url`, `image`, `summary`
- `SearchRequestDB`: Tracks research tasks with `status`, `response_id`, `date_range`, `new_wins_found`

### Frontend Patterns

**Component Structure:**

- `App.tsx`: Simple React Router setup (no context/state management)
- `Home.tsx`: Fetches `/api/wins`, displays HackerNews-style list, formats relative dates
- `Admin.tsx`: Triggers `/api/wins/search`, shows request confirmation (not real-time results)

**Styling:** Tailwind CSS 4 with minimal custom classes, gray-scale + red accent colors

**API Integration:** Vite proxy (`/api/*` → `http://localhost:3001`) configured in [vite.config.ts](../frontend/vite.config.ts)

## Critical Dependencies

- **Backend**: FastAPI, SQLAlchemy 2.0, asyncpg + psycopg2-binary, OpenAI SDK 1.0+
- **Frontend**: React Router 7.12, Tailwind CSS 4 (PostCSS), Vite 5
- **Python**: Requires 3.11+, managed via `uv` (not pip)
- **Node**: Recommended v18+

## Common Gotchas

1. **PostgreSQL must be running** before backend starts (dev.sh handles this)
2. **Port conflicts**: dev.sh kills processes on 3000/3001 before starting
3. **OpenAI API key**: Required in `.env` as `OPENAI_API_KEY` for research feature
4. **Background processing**: Search results aren't immediate - thread polls every few seconds
5. **Database migrations**: No formal migration system - manual ALTER TABLE in `init_db()` (see union_name column addition)
6. **Python package manager**: Use `uv sync`, NOT `pip install`

## File-Specific Conventions

- **Python** ([python.instructions.md](./instructions/python.instructions.md)): Follow type hints, async patterns, error handling
- **TypeScript** ([typescript-5-es2022.instructions.md](./instructions/typescript-5-es2022.instructions.md)): ES2022 target, strict mode
- **React** ([reactjs.instructions.md](./instructions/reactjs.instructions.md)): Functional components, hooks, Tailwind styling

## Testing & Debugging

- **Backend logs**: Background thread outputs to stdout (`print()` statements for debugging)
- **Frontend dev**: Vite HMR, React DevTools recommended
- **Database inspection**: `psql unionwins` to query tables directly
- **API testing**: Backend runs at `:3001/api/*`, supports CORS from localhost:3000

## Building

- Frontend
  - Build using command `npm run build` in `frontend/`
  - Production build: `cd frontend && npm run build` → outputs to `frontend/dist/`
- Backend
  - No formal build step; run with `uvicorn` in production mode
  - Use `python3`, not `python`

## Linting

- Frontend
  - TypeScript: Follow ESLint rules, use `npm run lint` in frontend
- Backend
  - Python: Follow PEP 8, use `ruff` or similar tools

## Updating this file

This file should be updated whenever

- There is a significant change to architecture or to feature fet
- There is something new learnt about the project
